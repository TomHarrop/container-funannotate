Bootstrap: shub
From: TomHarrop/funannotate-singularity:funannotate-base_1.6.0

%post
    # augustus config
    export AUGUSTUS_CONFIG_PATH="/usr/share/augustus/config"
    # allow BUSCO to *write* to the augustus config dir. Yuck.
    chmod -R 777 "${AUGUSTUS_CONFIG_PATH}"

    # install blast 2.2.31 for BUSCO
    wget -O "blast.tar.gz" \
        ftp://ftp.ncbi.nlm.nih.gov/blast/executables/blast+/2.2.31/ncbi-blast-2.2.31+-x64-linux.tar.gz
    mkdir /blast
    tar -zxf blast.tar.gz \
        -C /blast \
        --strip-components 1
    rm -f blast.tar.gz

    # codingquarry
    wget -O "codingquarry.tar.gz" \
        https://sourceforge.net/projects/codingquarry/files/CodingQuarry_v2.0.tar.gz
    mkdir codingquarry
    tar -zxf codingquarry.tar.gz \
        -C codingquarry \
        --strip-components 1
    cd codingquarry || exit 1
    make
    mv CodingQuarry /usr/local/bin/
    cd .. || exit 1
    rm -rf codingquarry codingquarry.tar.gz

    # blat & pslCDnaFilter
    wget -O /usr/local/bin/blat \
        http://hgdownload.cse.ucsc.edu/admin/exe/linux.x86_64/blat/blat
    wget -O /usr/local/bin/pslCDnaFilter \
        http://hgdownload.cse.ucsc.edu/admin/exe/linux.x86_64/pslCDnaFilter

    chmod 755 /usr/local/bin/blat
    chmod 755 /usr/local/bin/pslCDnaFilter

    # pasa
    wget -O "fasta.tar.gz" \
        http://faculty.virginia.edu/wrpearson/fasta/fasta36/fasta-36.3.8g.tar.gz
    mkdir fasta
    tar -zxf fasta.tar.gz \
        -C fasta \
        --strip-components 2
    rm -f fasta.tar.gz
    cd fasta/src || exit 1
    make -f ../make/Makefile.linux_sse2 all
    cd ../.. || exit 1
    cp fasta/bin/fasta36 /usr/local/bin/fasta

    wget -O "pasa.tar.gz" \
        https://github.com/PASApipeline/PASApipeline/releases/download/pasa-v2.3.3/PASApipeline-v2.3.3.tar.gz
    mkdir pasa
    tar -zxf pasa.tar.gz \
        -C pasa \
        --strip-components 1
    rm -f pasa.tar.gz
    cd pasa || exit 1
    make
    cd .. || exit 1

    # genemark
    wget -O genemark_download.sh \
        --no-check-certificate \
        https://raw.githubusercontent.com/TomHarrop/funannotate-singularity/master/src/genemark_download.sh
    bash genemark_download.sh
    rm genemark_download.sh

    # kallisto
    wget -O "kallisto.tar.gz" \
        https://github.com/pachterlab/kallisto/releases/download/v0.46.0/kallisto_linux-v0.46.0.tar.gz
    mkdir kallisto
    tar -zxf kallisto.tar.gz \
        -C kallisto \
        --strip-components 1
    mv kallisto/kallisto /usr/local/bin/
    rm -rf kallisto kallisto.tar.gz
 
    # stringtie
    wget -O stringtie.tar.gz \
        --no-check-certificate \
        http://ccb.jhu.edu/software/stringtie/dl/stringtie-1.3.6.Linux_x86_64.tar.gz
    mkdir stringtie
    tar -zxf stringtie.tar.gz \
        -C stringtie \
        --strip-components 1
    mv stringtie/stringtie /usr/local/bin/
    rm -rf stringtie stringtie.tar.gz

    # trimal
    wget -O trimal.tar.gz \
        --no-check-certificate \
        https://github.com/scapella/trimal/archive/v1.4.1.tar.gz
    mkdir trimal
    tar -zxf trimal.tar.gz \
        -C trimal \
        --strip-components 1
    cd trimal/source || exit 1
    make
    mv readal statal trimal /usr/local/bin/
    cd ../../ || exit 1
    rm -rf trimal trimal.tar.gz

    # evidence modeller
    wget -O evm.tar.gz \
        --no-check-certificate \
    https://github.com/EVidenceModeler/EVidenceModeler/archive/v1.1.1.tar.gz
    mkdir evm
    tar -zxf evm.tar.gz \
        -C evm \
        --strip-components 1
    rm -f evm.tar.gz

    # glimmerhmm
    (
    wget -O glimmerhmm.tar.gz \
        --no-check-certificate \
    https://ccb.jhu.edu/software/glimmerhmm/dl/GlimmerHMM-3.0.4.tar.gz
    mkdir glimmerhmm
    tar -zxf glimmerhmm.tar.gz \
        -C glimmerhmm \
        --strip-components 1
    cd glimmerhmm || exit 1

    # from here, follow the conda recipe from https://raw.githubusercontent.com/bioconda/bioconda-recipes/master/recipes/glimmerhmm/build.sh
    export PREFIX=/usr/local
    # fix typos in train makefile
    sed -i.bak "s|^escoreSTOP2:|scoreSTOP2:|g" train/makefile
    sed -i.bak "s|^rfapp:|erfapp:|g" train/makefile
    sed -i.bak "s| trainGlimmerHMM||g" train/makefile
    sed -i.bak "s|all:    build-icm|all:    misc.o build-icm.o build-icm-noframe.o build-icm|g" train/makefile

    # fix perl scripts
    sed -i.bak '1 s|^.*$|#!/usr/bin/env perl|g' train/trainGlimmerHMM
    sed -i.bak 's|FindBin;|FindBin qw($RealBin);|g' train/trainGlimmerHMM
    sed -i.bak 's|$FindBin::Bin;|"$RealBin/../share/glimmerhmm/train";|g' train/trainGlimmerHMM
    sed -i.bak '1 s|^.*$|#!/usr/bin/env perl|g' bin/glimmhmm.pl

    # make directories for storing training data and binaries
    mkdir -p $PREFIX/bin
    mkdir -p $PREFIX/share/glimmerhmm
    mkdir -p $PREFIX/share/glimmerhmm/train

    # make
    make -C sources
    make -C train clean && make -C train all

    # copy the executables  
    cp bin/glimmhmm.pl $PREFIX/bin/
    cp sources/glimmerhmm $PREFIX/bin/
    cp train/trainGlimmerHMM $PREFIX/bin/
    cp train/build-icm $PREFIX/share/glimmerhmm/train/
    cp train/build-icm-noframe $PREFIX/share/glimmerhmm/train/
    cp train/build1 $PREFIX/share/glimmerhmm/train/
    cp train/build2 $PREFIX/share/glimmerhmm/train/
    cp train/erfapp $PREFIX/share/glimmerhmm/train/
    cp train/falsecomp $PREFIX/share/glimmerhmm/train/
    cp train/findsites $PREFIX/share/glimmerhmm/train/
    cp train/karlin $PREFIX/share/glimmerhmm/train/
    cp train/score $PREFIX/share/glimmerhmm/train/
    cp train/score2 $PREFIX/share/glimmerhmm/train/
    cp train/scoreATG $PREFIX/share/glimmerhmm/train/
    cp train/scoreATG2 $PREFIX/share/glimmerhmm/train/
    cp train/scoreSTOP $PREFIX/share/glimmerhmm/train/
    cp train/scoreSTOP2 $PREFIX/share/glimmerhmm/train/
    cp train/splicescore $PREFIX/share/glimmerhmm/train/

    # copy the perl modules
    cp train/*.pm $PREFIX/share/glimmerhmm/train/

    # copy the training data
    cp -R trained_dir $PREFIX/share/glimmerhmm/

    cd ../ || exit 1
    rm -r glimmerhmm.tar.gz glimmerhmm
    )
