Bootstrap: docker
From: ubuntu:19.10

%runscript
    exec /usr/local/RepeatMasker/RepeatMasker "$@"

%environment
    export LC_ALL=C
    export PATH="${PATH}:/usr/local/RepeatMasker:/rmblast/bin:/recon/bin:/recon/scripts:/usr/local/RepeatScout-1.0.5"


%post
    # faster apt downloads
    export DEBIAN_FRONTEND=noninteractive
    export LC_ALL=C
    export PATH="${PATH}:/usr/local/RepeatMasker:/rmblast/bin:/recon/bin:/recon/scripts:/usr/local/RepeatScout-1.0.5"

    (
        . /etc/os-release
        cat << _EOF_ > mirror.txt
deb mirror://mirrors.ubuntu.com/mirrors.txt ${UBUNTU_CODENAME} main restricted universe multiverse
deb mirror://mirrors.ubuntu.com/mirrors.txt ${UBUNTU_CODENAME}-updates main restricted universe multiverse
deb mirror://mirrors.ubuntu.com/mirrors.txt ${UBUNTU_CODENAME}-backports main restricted universe multiverse
deb mirror://mirrors.ubuntu.com/mirrors.txt ${UBUNTU_CODENAME}-security main restricted universe multiverse

_EOF_
        mv /etc/apt/sources.list /etc/apt/sources.list.bak
        cat mirror.txt /etc/apt/sources.list.bak > /etc/apt/sources.list
    )

    # apt dependencies
    apt-get update
    apt-get install -y \
        build-essential \
        hmmer \
        ncbi-blast+ \
        unzip \
        wget \
        libjson-perl \
        liburi-perl \
        libtest-lwp-useragent-perl \
        libfile-which-perl


    # trf
    wget \
        -O /usr/local/bin/trf \
        http://tandem.bu.edu/trf/downloads/trf409.linux64
    chmod +x /usr/local/bin/trf

    # rmblast
    wget \
        -O rmblast.tar.gz \
        --no-check-certificate \
        http://www.repeatmasker.org/rmblast-2.10.0+-x64-linux.tar.gz
    mkdir /rmblast
    tar -zxf rmblast.tar.gz \
        -C /rmblast \
        --strip-components 1
    rm rmblast.tar.gz

    # recon
    wget \
        -O recon.tar.gz \
        --no-check-certificate \
        http://www.repeatmasker.org/RepeatModeler/RECON-1.08.tar.gz
    mkdir /recon
    tar -zxf recon.tar.gz \
        -C /recon \
        --strip-components 1
    rm recon.tar.gz
    (
    cd /recon/src || exit 1
    make && make install
    perl -i -0pe 's/\$path = "";/\$path = "\/recon\/bin";/g' ../scripts/\recon.pl
    )

    # nseg (for repeat scout)
    (
    mkdir /nseg && cd /nseg || exit 1
    wget  \
        --no-check-certificate \
        ftp://ftp.ncbi.nih.gov/pub/seg/nseg/*
    make
    mv nseg nmerge /usr/local/bin/
    )
    rm -r /nseg

    # RepeatScout
    wget \
        -O repeatscout.tar.gz \
        --no-check-certificate \
        http://www.repeatmasker.org/RepeatScout-1.0.6.tar.gz
    mkdir /repeatscout
    tar -zxf repeatscout.tar.gz \
        -C /repeatscout \
        --strip-components 1
    rm repeatscout.tar.gz
    (
    cd /repeatscout || exit 1
    make && make install
    )
    rm -r /repeatscout

    # repeatmasker
    wget \
        -O repeatmasker.tar.gz \
        --no-check-certificate \
        http://www.repeatmasker.org/RepeatMasker-4.1.0.tar.gz
    mkdir /usr/local/RepeatMasker
    tar -zxf repeatmasker.tar.gz \
        -C /usr/local/RepeatMasker \
        --strip-components 1
    rm repeatmasker.tar.gz
    
    # configure repeatmasker
    chmod -R 777 /usr/local/RepeatMasker/Libraries
    (
    cd /usr/local/RepeatMasker || exit 1
    perl configure \
        -trf_prgm /usr/local/bin/trf \
        -default_search_engine rmblast \
        -rmblast_dir /rmblast/bin \
        -hmmer_dir /usr/bin \
        -libdir /usr/local/RepeatMasker/Libraries
    )

    # repeatmodeller
    wget \
        -O repeatmodeller.tar.gz \
        --no-check-certificate \
        http://repeatmasker.org/RepeatModeler/RepeatModeler-2.0.1.tar.gz
    mkdir /usr/local/RepeatModeler
    tar -zxf repeatmodeller.tar.gz \
        -C /usr/local/RepeatModeler \
        --strip-components 1
    rm repeatmodeller.tar.gz

    # configure repeatmodeller
    (
    cd /usr/local/RepeatModeler || exit 1
    perl configure \
        -recon_dir /recon \
        -rmblast_dir /rmblast \
        -rscout_dir /usr/local/RepeatScout-1.0.5 \
        -trf_prgm /usr/local/bin/trf \
        -repeatmasker_dir /usr/local/RepeatMasker \
        -ltr_retriever_dir "n"
    )